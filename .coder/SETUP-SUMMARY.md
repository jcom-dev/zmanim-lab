# E2E Testing Setup - Summary

## âœ… All Changes Complete!

### Files Modified:

1. **`.coder/zmanim-lab-workspace.tf`**
   - Added PostgreSQL 16 container (localhost:5433)
   - Added Redis 7 container (localhost:6380)
   - Added test environment variables
   - Added Clerk test instance support
   - Added MailSlurp API key variable

2. **`.coder/startup.sh`**
   - Auto-creates `api/.env` with test DB/cache
   - Auto-creates `web/.env.local` with test credentials
   - Auto-creates `tests/.env` with all test config
   - Shows test service status on startup

3. **`.coder/push-template.sh`**
   - Sources `.env.clerk` (production + test keys)
   - Sources `.env.mailslurp` (for E2E email testing)
   - Made `.env.upstash` optional (using local Redis)
   - Generates `terraform.tfvars` with test variables

4. **`docker-compose.yml`**
   - Added `postgres-test` service (port 5433)
   - Added `redis-test` service (port 6380)
   - Added health checks for both services

5. **`tests/.env.example`**
   - Updated with local database and cache
   - Added Clerk test instance variables
   - Added MailSlurp configuration

### Files Created:

1. **`.env.clerk.example`** - Template for Clerk keys (production + test)
2. **`.env.mailslurp.example`** - Template for MailSlurp API key
3. **`.coder/DEPLOYMENT-GUIDE.md`** - Complete deployment instructions

---

## ðŸš€ Quick Start Guide

### 1. Create Test Credentials

**Clerk Test Instance:**
```bash
1. Go to https://dashboard.clerk.com
2. Create new application "Zmanim Lab Test"
3. Copy pk_test_... and sk_test_... keys
```

**MailSlurp:**
```bash
1. Sign up at https://app.mailslurp.com
2. Copy API key from dashboard
```

### 2. Create .env Files

```bash
# In project root
cp .env.clerk.example .env.clerk
cp .env.mailslurp.example .env.mailslurp

# Edit both files with your credentials
nano .env.clerk
nano .env.mailslurp
```

### 3. Push Template & Rebuild

```bash
cd .coder/
./push-template.sh
# Then rebuild workspace in Coder UI
```

### 4. Verify & Test

After workspace starts, you'll see:

```
âœ… api/.env created from Coder variables
âœ… web/.env.local created from Coder variables
âœ… tests/.env created with local database and cache

Test environment configured:
  - Database: localhost:5433
  - Redis: localhost:6380
  - Clerk: TEST instance
  - MailSlurp: configured
```

Run tests:
```bash
cd tests/
npm run test:suite
```

---

## ðŸ“‹ Environment File Structure

```
zmanim-lab/
â”œâ”€â”€ .env.clerk          # Clerk keys (prod + test)
â”œâ”€â”€ .env.mailslurp      # MailSlurp API key
â”œâ”€â”€ .env.supabase       # Production database
â”œâ”€â”€ .env.resend         # Email service
â”œâ”€â”€ .env.upstash        # Optional (using local Redis)
â”‚
â”œâ”€â”€ api/.env            # Auto-generated by startup
â”œâ”€â”€ web/.env.local      # Auto-generated by startup
â””â”€â”€ tests/.env          # Auto-generated by startup
```

**Important:**
- `.env.*` files in project root are NOT auto-generated
- They are sourced by `push-template.sh` to create terraform.tfvars
- `api/`, `web/`, and `tests/` .env files ARE auto-generated on workspace startup

---

## ðŸ”§ What Happens on Workspace Start

1. **PostgreSQL container starts** (localhost:5433)
2. **Redis container starts** (localhost:6380)
3. **Startup script runs** and creates:
   - `api/.env` with production + test database/cache
   - `web/.env.local` with production + test Clerk
   - `tests/.env` with test database, cache, and Clerk test instance
4. **Services start** (web on :3001, API on :8080)

---

## ðŸ“š Documentation

- **Full Guide**: `.coder/DEPLOYMENT-GUIDE.md`
- **Testing Guide**: `tests/TESTING.md`
- **Terraform Vars**: `.coder/terraform.tfvars.example`

---

## ðŸŽ¯ Next Steps

1. âœ… Create `.env.clerk` with production and test Clerk keys
2. âœ… Create `.env.mailslurp` with API key
3. âœ… Run `./push-template.sh` from `.coder/` directory
4. âœ… Rebuild workspace in Coder UI
5. âœ… Verify test environment is configured
6. âœ… Run E2E tests: `cd tests && npm run test:suite`
7. ðŸŽ‰ All tests should pass!

---

**Questions?** Check `DEPLOYMENT-GUIDE.md` for troubleshooting and detailed instructions.

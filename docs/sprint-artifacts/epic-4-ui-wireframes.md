# Epic 4: UI Wireframes - Edit Zman Modal

**Epic:** Intuitive Zmanim Algorithm Editor with AI-Powered DSL
**Author:** BMad
**Date:** 2025-11-28
**Status:** Planning

---

## Overview

This document contains complete UI/UX wireframes for the **Edit Zman Modal** - the centerpiece of Epic 4's Apple-quality user experience. The modal supports:

- **DSL formula editing** with CodeMirror 6 and intelligent autocomplete
- **AI-powered generation** from natural language descriptions
- **Real-time validation** with helpful error messages
- **Live preview** with calculation breakdowns
- **Weekly calendar** with Hebrew dates and Jewish events
- **Browse & copy** formulas from other publishers
- **Bilingual interface** (Hebrew + English)

---

## Modal States & Interactions

### State 1: View Mode (Default)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Edit: Sof Zman Shma - GR"A         ×¡×•×£ ×–××Ÿ ×§×¨×™××ª ×©××¢ - ×’×¨"×         [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Formula â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  sunrise + shaos(3, gra)                                    [Edit]   â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  âœ“ Valid formula                                                     â”‚  â”‚
â”‚  â”‚  â“˜ Dependencies: sunrise                                             â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ AI Explanation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  This zman is calculated as 3 proportional hours (shaos zmaniyos)    â”‚  â”‚
â”‚  â”‚  after sunrise according to the Vilna Gaon (GRA) method.             â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  A proportional hour is 1/12 of the time from sunrise to sunset.     â”‚  â”‚
â”‚  â”‚  On this day, sunrise is at 6:34 AM and sunset is at 6:47 PM,       â”‚  â”‚
â”‚  â”‚  making the day 12 hours 13 minutes long.                            â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  One proportional hour = 1 hour 1 minute                             â”‚  â”‚
â”‚  â”‚  Three proportional hours = 3 hours 3 minutes                        â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  Therefore, Sof Zman Shma is at 9:37 AM (6:34 + 3:03).              â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  [ğŸ¤– Regenerate Explanation]                                               â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Public Comment (shown to users) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  We follow the opinion of the Vilna Gaon (GR"A), calculating Sof    â”‚  â”‚
â”‚  â”‚  Zman Shma as three proportional hours after sunrise. This           â”‚  â”‚
â”‚  â”‚  calculation divides the daytime (from sunrise to sunset) into 12    â”‚  â”‚
â”‚  â”‚  equal parts and counts three of them.                               â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  [ğŸ¤– AI: Generate Comment]  [Edit Comment]                                 â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Live Preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ“… Today (Nov 24, 2024)                                              â”‚  â”‚
â”‚  â”‚  ğŸ“ New York, NY                                                      â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  â° Sof Zman Shma: 9:37 AM                                           â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  Calculation breakdown:                                               â”‚  â”‚
â”‚  â”‚  â€¢ Sunrise: 6:34 AM                                                  â”‚  â”‚
â”‚  â”‚  â€¢ Sunset: 6:47 PM                                                   â”‚  â”‚
â”‚  â”‚  â€¢ Day length: 12h 13min                                             â”‚  â”‚
â”‚  â”‚  â€¢ 1 Proportional hour: 1h 1min                                      â”‚  â”‚
â”‚  â”‚  â€¢ 3 Proportional hours: 3h 3min                                     â”‚  â”‚
â”‚  â”‚  â€¢ Result: 6:34 AM + 3:03 = 9:37 AM                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  [ğŸ“… Preview Week]                                                         â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Options â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â˜‘ Enabled      â˜‘ Visible      â˜ Hidden      ğŸ”’ Required (locked)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  [Cancel]                                                   [Save Changes] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Features:**
- Read-only formula display with "Edit" button
- AI-generated explanation of the calculation
- Publisher's public comment field
- Live preview showing today's calculated time with breakdown
- Options: Enabled/Visible/Hidden/Required (some locked for mandatory zmanim)
- Weekly preview button

---

### State 2: Formula Edit Mode (CodeMirror Active)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Edit: Sof Zman Shma - GR"A         ×¡×•×£ ×–××Ÿ ×§×¨×™××ª ×©××¢ - ×’×¨"×         [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Formula â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  1  sunrise + shaos(3â–ˆ                                               â”‚  â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚  â”‚
â”‚  â”‚     â”‚ ğŸ“˜ Autocomplete                      â”‚                         â”‚  â”‚
â”‚  â”‚     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚  â”‚
â”‚  â”‚     â”‚ shaos(hours, base)                   â”‚  â† Function signature   â”‚  â”‚
â”‚  â”‚     â”‚   Calculate proportional hours       â”‚                         â”‚  â”‚
â”‚  â”‚     â”‚   hours: 0.5 - 12.0                  â”‚  â† Parameter hints      â”‚  â”‚
â”‚  â”‚     â”‚   base: gra | mga | mga_90 | ...     â”‚                         â”‚  â”‚
â”‚  â”‚     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚  â”‚
â”‚  â”‚     â”‚ solar(degrees, direction)            â”‚  â† Related functions    â”‚  â”‚
â”‚  â”‚     â”‚ solar_noon                            â”‚                         â”‚  â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  ğŸ’¡ Hint: Type "shaos(" to see parameters                            â”‚  â”‚
â”‚  â”‚  âœ“ Formula valid Â· Auto-saving...                                    â”‚  â”‚
â”‚  â”‚  â“˜ Dependencies: sunrise                                             â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  [âœ¨ AI: Generate Formula]  [ğŸ“‹ Browse Templates]  [Done Editing]          â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Quick Reference (collapsible) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  Primitives: sunrise | sunset | solar_noon | civil_dawn | ...        â”‚  â”‚
â”‚  â”‚  Functions:  solar(Â°, dir) | shaos(hrs, base) | midpoint(t1, t2)    â”‚  â”‚
â”‚  â”‚  Operators:  + - * / ()                                              â”‚  â”‚
â”‚  â”‚  Durations:  72min | 1hr 30min | 18min                              â”‚  â”‚
â”‚  â”‚  References: @alos_hashachar | @chatzos | ...                        â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  [ğŸ“– View Full Documentation]                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ AI Explanation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  (Auto-regenerates as formula changes)                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Live Preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  (Updates in real-time as formula changes)                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  [Cancel]                                                   [Save Changes] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Features:**
- **CodeMirror 6** editor with line numbers
- **Intelligent autocomplete** with:
  - Function signatures and parameter hints
  - Type information (primitive, function, reference)
  - Context-sensitive suggestions
- **Real-time validation** with inline indicators
- **Auto-save** with debouncing
- **Dependency tracking** (shows which zmanim this formula depends on)
- **Quick Reference** panel (collapsible) with DSL syntax cheat sheet
- Action buttons: AI Generate, Browse Templates, Done Editing

---

### State 2b: Formula Edit Mode with Enhanced Live Preview (Split-Screen)

When you click **Edit** on a formula, the modal transforms into a split-screen view with **real-time preview** showing calculation results as you type.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Edit: Sof Zman Shma - GR"A     ×¡×•×£ ×–××Ÿ ×§×¨×™××ª ×©××¢ - ×’×¨"×           [Ã—]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  FORMULA EDITOR                     â”‚  LIVE PREVIEW                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚                                      â”‚
â”‚  â”Œâ”€ DSL Code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€ Calculated Result â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                â”‚ â”‚  â”‚                                 â”‚ â”‚
â”‚  â”‚  1  sunrise + shaos(3, gra)â–ˆ  â”‚ â”‚  â”‚  â° 9:37 AM                     â”‚ â”‚
â”‚  â”‚                                â”‚ â”‚  â”‚                                 â”‚ â”‚
â”‚  â”‚  âœ“ Valid formula               â”‚ â”‚  â”‚  Updates live as you type      â”‚ â”‚
â”‚  â”‚  â“˜ Dependencies: sunrise       â”‚ â”‚  â”‚  (300ms debounce)              â”‚ â”‚
â”‚  â”‚                                â”‚ â”‚  â”‚                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚                                      â”‚
â”‚  ğŸ’¡ Hint: Press Ctrl+Space         â”‚  â”Œâ”€ Calculation Breakdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚     for autocomplete                â”‚  â”‚                                 â”‚ â”‚
â”‚                                     â”‚  â”‚  ğŸ“… Today: Nov 24, 2024         â”‚ â”‚
â”‚  [âœ¨ AI Generate]                   â”‚  â”‚  ğŸ“ Location: New York, NY      â”‚ â”‚
â”‚  [ğŸ“‹ Browse Templates]              â”‚  â”‚                                 â”‚ â”‚
â”‚  [ğŸ“– DSL Reference]                 â”‚  â”‚  Step-by-step:                  â”‚ â”‚
â”‚                                     â”‚  â”‚  1. Sunrise: 6:34 AM            â”‚ â”‚
â”‚  â”Œâ”€ Quick Tips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  2. Sunset: 6:47 PM             â”‚ â”‚
â”‚  â”‚                                â”‚ â”‚  â”‚  3. Day length: 12h 13min       â”‚ â”‚
â”‚  â”‚  Primitives:                   â”‚ â”‚  â”‚  4. Shaah Zmanis (GRA):         â”‚ â”‚
â”‚  â”‚  â€¢ sunrise, sunset             â”‚ â”‚  â”‚     = 12h 13min Ã· 12            â”‚ â”‚
â”‚  â”‚  â€¢ solar_noon                  â”‚ â”‚  â”‚     = 1h 1min                   â”‚ â”‚
â”‚  â”‚                                â”‚ â”‚  â”‚  5. 3 Shaos:                    â”‚ â”‚
â”‚  â”‚  Functions:                    â”‚ â”‚  â”‚     = 1h 1min Ã— 3               â”‚ â”‚
â”‚  â”‚  â€¢ solar(Â°, dir)               â”‚ â”‚  â”‚     = 3h 3min                   â”‚ â”‚
â”‚  â”‚  â€¢ shaos(hrs, base)            â”‚ â”‚  â”‚  6. Final:                      â”‚ â”‚
â”‚  â”‚  â€¢ midpoint(t1, t2)            â”‚ â”‚  â”‚     = 6:34 AM + 3h 3min         â”‚ â”‚
â”‚  â”‚                                â”‚ â”‚  â”‚     = 9:37 AM                   â”‚ â”‚
â”‚  â”‚  [See Full Reference]          â”‚ â”‚  â”‚                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚                                      â”‚
â”‚                                     â”‚  â”Œâ”€ Test Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                                     â”‚  â”‚                                 â”‚ â”‚
â”‚                                     â”‚  â”‚  ğŸ“… Date: [Nov 24 â–¾]            â”‚ â”‚
â”‚                                     â”‚  â”‚  ğŸ“ Location: [NY â–¾]            â”‚ â”‚
â”‚                                     â”‚  â”‚                                 â”‚ â”‚
â”‚                                     â”‚  â”‚  [ğŸ“… Preview Week]              â”‚ â”‚
â”‚                                     â”‚  â”‚  [ğŸŒ Test Other Locations]      â”‚ â”‚
â”‚                                     â”‚  â”‚                                 â”‚ â”‚
â”‚                                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€ AI Explanation (auto-generated) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  This zman is calculated as 3 proportional hours (shaos zmaniyos)     â”‚ â”‚
â”‚  â”‚  after sunrise according to the Vilna Gaon (GRA) method. A            â”‚ â”‚
â”‚  â”‚  proportional hour is 1/12 of the time from sunrise to sunset.        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  [ğŸ¤– Regenerate Explanation]                                               â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Public Comment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  We follow the opinion of the Vilna Gaon (GR"A)...                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  [ğŸ¤– AI: Generate Comment]  [âœï¸ Edit Comment]                              â”‚
â”‚                                                                             â”‚
â”‚  [Cancel]                                                   [Save Changes] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Enhanced Preview Features:**

1. **Split-Screen Layout**
   - Left: Formula editor (CodeMirror 6)
   - Right: Live calculation preview
   - Resizable divider (drag to adjust)

2. **Real-Time Calculation**
   - Updates automatically as you type (300ms debounce)
   - Shows calculated result prominently
   - Full step-by-step breakdown

3. **Interactive Test Controls**
   - Change date to test formula on different days
   - Change location to test different lat/long
   - Quick access to weekly preview

4. **Visual Calculation Breakdown**
   - Shows each step of the calculation
   - Mathematical operations displayed clearly
   - Easy to verify formula logic

5. **Quick Tips Panel**
   - Collapsible reference guide
   - Common primitives and functions
   - Link to full DSL documentation

6. **Error Highlighting in Preview**
   - If formula is invalid, preview shows error
   - Red border around result
   - Helpful error message

**Example with Error:**

```
â”Œâ”€ LIVE PREVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    â”‚
â”‚  âŒ Formula Error                  â”‚
â”‚                                    â”‚
â”‚  Parameter 'hours' must be         â”‚
â”‚  between 0.5 and 12.0              â”‚
â”‚                                    â”‚
â”‚  Got: 15                           â”‚
â”‚                                    â”‚
â”‚  ğŸ’¡ Did you mean: shaos(10.5, gra)?â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Example with Location Change:**

```
â”Œâ”€ Test Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    â”‚
â”‚  ğŸ“… Date: [Dec 21, 2024 â–¾]         â”‚
â”‚  ğŸ“ Location:                       â”‚
â”‚      [Jerusalem â–¾]                 â”‚
â”‚                                    â”‚
â”‚  Result updates:                   â”‚
â”‚  â° 8:42 AM                         â”‚
â”‚  (Different sunrise time)          â”‚
â”‚                                    â”‚
â”‚  [ğŸ“… Preview Week]                 â”‚
â”‚  [ğŸŒ Common Locations â–¾]           â”‚
â”‚    â€¢ New York                      â”‚
â”‚    â€¢ Jerusalem                     â”‚
â”‚    â€¢ London                        â”‚
â”‚    â€¢ Los Angeles                   â”‚
â”‚    â€¢ Custom...                     â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### State 3: AI Formula Generation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Edit: Custom Zman             ×–××Ÿ ××•×ª×× ××™×©×™×ª                        [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€ AI Formula Generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  Describe your zman calculation in plain language:                    â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ I want to calculate 45 minutes after sunset, but if the        â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ location is above 60 degrees latitude, use civil dusk instead  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ because polar regions have extended twilight.â–ˆ                  â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  [ğŸ¤– Generate Formula]                                                â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  âœ… AI Generated Formula:                                             â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ if (latitude > 60) {                                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚   civil_dusk                                                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ } else {                                                        â”‚ â”‚  â”‚
â”‚  â”‚  â”‚   sunset + 45min                                                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ }                                                               â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  AI Explanation:                                                      â”‚  â”‚
â”‚  â”‚  "This formula uses a conditional to handle high-latitude regions.   â”‚  â”‚
â”‚  â”‚   For locations above 60Â°N/S, it uses civil dusk (-6Â° solar angle)   â”‚  â”‚
â”‚  â”‚   which is more reliable in polar regions. For normal latitudes,     â”‚  â”‚
â”‚  â”‚   it simply adds 45 minutes to sunset."                              â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  [âœï¸ Edit Formula]  [âœ… Use This Formula]  [ğŸ”„ Regenerate]            â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Live Preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  (Shows calculated result for generated formula)                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  [Cancel]                                                   [Save Changes] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Features:**
- **Natural language input** text area
- **AI generation** button triggers Claude API with RAG context
- **Generated formula** displayed in read-only code block
- **AI explanation** of the generated formula
- **Actions:** Edit (open in CodeMirror), Use (accept), Regenerate (try again)
- **Live preview** updates to show generated formula result
- Uses **RAG context** from postgres pgvector (hebcal, KosherJava sources)

---

### State 4: Weekly Preview Expanded

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Preview: Sof Zman Shma - GR"A                      [Year â–¾] [Week â–¾]  [Ã—] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Week of December 1-7, 2024                    ğŸ“ New York, NY             â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Monday, Dec 2 â€¢ ×‘×³ ×›×¡×œ×• ×ª×©×¤×´×” â€¢ 2nd Day of Chanukah                 â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚  â”‚  Sunrise:           6:35 AM                                           â”‚  â”‚
â”‚  â”‚  Sunset:            6:46 PM                                           â”‚  â”‚
â”‚  â”‚  Day Length:        12h 11min                                         â”‚  â”‚
â”‚  â”‚  Shaah Zmanis:      1h 1min                                           â”‚  â”‚
â”‚  â”‚  â° Sof Zman Shma:  9:38 AM  (6:35 + 3:03)                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Tuesday, Dec 3 â€¢ ×’×³ ×›×¡×œ×• ×ª×©×¤×´×” â€¢ 3rd Day of Chanukah                â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚  â”‚  Sunrise:           6:36 AM                                           â”‚  â”‚
â”‚  â”‚  Sunset:            6:46 PM                                           â”‚  â”‚
â”‚  â”‚  Day Length:        12h 10min                                         â”‚  â”‚
â”‚  â”‚  Shaah Zmanis:      1h 1min                                           â”‚  â”‚
â”‚  â”‚  â° Sof Zman Shma:  9:39 AM  (6:36 + 3:03)                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Wednesday, Dec 4 â€¢ ×“×³ ×›×¡×œ×• ×ª×©×¤×´×” â€¢ 4th Day of Chanukah              â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚  â”‚  Sunrise:           6:37 AM                                           â”‚  â”‚
â”‚  â”‚  Sunset:            6:46 PM                                           â”‚  â”‚
â”‚  â”‚  Day Length:        12h 9min                                          â”‚  â”‚
â”‚  â”‚  Shaah Zmanis:      1h 1min                                           â”‚  â”‚
â”‚  â”‚  â° Sof Zman Shma:  9:40 AM  (6:37 + 3:03)                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Thursday, Dec 5 â€¢ ×”×³ ×›×¡×œ×• ×ª×©×¤×´×” â€¢ 5th Day of Chanukah               â”‚  â”‚
â”‚  â”‚  ... (similar format)                                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Friday, Dec 6 â€¢ ×•×³ ×›×¡×œ×• ×ª×©×¤×´×” â€¢ 6th Day of Chanukah                 â”‚  â”‚
â”‚  â”‚  ... (similar format)                                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Saturday, Dec 7 â€¢ ×–×³ ×›×¡×œ×• ×ª×©×¤×´×” â€¢ 7th Day of Chanukah â€¢ Shabbat    â”‚  â”‚
â”‚  â”‚  ... (similar format)                                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Sunday, Dec 8 â€¢ ×—×³ ×›×¡×œ×• ×ª×©×¤×´×” â€¢ 8th Day of Chanukah                 â”‚  â”‚
â”‚  â”‚  ... (similar format)                                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  [â¬… Previous Week]                                        [Next Week â¡]    â”‚
â”‚  [Close Preview]                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Features:**
- **7-day week view** (Sunday through Saturday)
- **Trilingual dates:** English, Hebrew, Hebrew year
- **Jewish events** from hebcal-go (all events except Israeli holidays)
  - Chanukah, Rosh Chodesh, Fast days, etc.
  - Shabbat notation
- **Full calculation breakdown** for each day:
  - Sunrise/Sunset times
  - Day length
  - Shaah Zmanis duration
  - Final calculated zman with formula
- **Year/Week picker** dropdowns for navigation
- **Previous/Next week** navigation buttons
- Uses **hebcal-go** for Hebrew calendar integration

---

### State 5: Error/Validation State

#### Example A: Invalid Parameter

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Edit: Sof Zman Shma - GR"A         ×¡×•×£ ×–××Ÿ ×§×¨×™××ª ×©××¢ - ×’×¨"×         [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Formula â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  1  sunrise + shaos(15, gra)                                         â”‚  â”‚
â”‚  â”‚                           ~~                                         â”‚  â”‚
â”‚  â”‚  âŒ Error on line 1, column 21:                                       â”‚  â”‚
â”‚  â”‚     Parameter 'hours' must be between 0.5 and 12.0                   â”‚  â”‚
â”‚  â”‚     Got: 15                                                           â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  ğŸ’¡ Did you mean: shaos(10.5, gra)?                                  â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ AI Explanation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  (Grayed out until formula is valid)                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Live Preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  âš ï¸ Cannot preview - formula has errors                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  [Cancel]                                       [Save Changes] (disabled)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Example B: Circular Dependency

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Edit: Tzais Custom                                                    [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Formula â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  1  @tzais_custom + 30min                                            â”‚  â”‚
â”‚  â”‚      ~~~~~~~~~~~~~                                                   â”‚  â”‚
â”‚  â”‚  âš ï¸  Circular dependency detected!                                    â”‚  â”‚
â”‚  â”‚     @tzais_custom references itself (directly or indirectly)         â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚     Dependency chain:                                                 â”‚  â”‚
â”‚  â”‚     tzais_custom â†’ tzais_custom (circular!)                          â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  ğŸ’¡ Reference a different zman or use a primitive/function           â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  [Cancel]                                       [Save Changes] (disabled)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Example C: Syntax Error

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Edit: Mincha Custom                                                   [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Formula â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  1  solar_noon + 30min +                                             â”‚  â”‚
â”‚  â”‚                           ~                                          â”‚  â”‚
â”‚  â”‚  âŒ Syntax error on line 1, column 24:                                â”‚  â”‚
â”‚  â”‚     Unexpected end of expression                                      â”‚  â”‚
â”‚  â”‚     Expected: time, number, or function                               â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  ğŸ’¡ Formulas cannot end with an operator                             â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  [Cancel]                                       [Save Changes] (disabled)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Features:**
- **Inline error highlighting** (squiggly underlines like VS Code)
- **Precise error location** (line and column numbers)
- **Clear error messages** with explanation
- **Helpful suggestions** ("Did you mean...?")
- **Error categories:**
  - Syntax errors (parsing failures)
  - Semantic errors (invalid parameters, types)
  - Circular dependencies
  - Missing references
- **Disabled state** for preview and save until errors are fixed
- **Real-time validation** as user types (debounced)

---

### State 6: Browse & Copy from Other Publishers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Copy Formula from Another Publisher                                   [Ã—] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Find similar calculations:  [sof zman shma                    ] [Search]  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ• OU Kosher                                                         â”‚  â”‚
â”‚  â”‚  Sof Zman Shma - GR"A                                                 â”‚  â”‚
â”‚  â”‚  Formula: sunrise + shaos(3, gra)                                     â”‚  â”‚
â”‚  â”‚  âœ“ 847 communities use this                                           â”‚  â”‚
â”‚  â”‚                                              [View Details] [ğŸ“‹ Copy] â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  ğŸ• Chabad.org                                                        â”‚  â”‚
â”‚  â”‚  Sof Zman Shma - MG"A                                                 â”‚  â”‚
â”‚  â”‚  Formula: sunrise - 72min + shaos(3, mga)                            â”‚  â”‚
â”‚  â”‚  âœ“ 612 communities use this                                           â”‚  â”‚
â”‚  â”‚                                              [View Details] [ğŸ“‹ Copy] â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  ğŸ• Jerusalem Rabbinate                                               â”‚  â”‚
â”‚  â”‚  Sof Zman Shma - GR"A (Custom)                                        â”‚  â”‚
â”‚  â”‚  Formula: sunrise + (sunset - sunrise) * 0.25                        â”‚  â”‚
â”‚  â”‚  Note: Manual calculation, same result as shaos(3, gra)              â”‚  â”‚
â”‚  â”‚  âœ“ 143 communities use this                                           â”‚  â”‚
â”‚  â”‚                                              [View Details] [ğŸ“‹ Copy] â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  ğŸ• Star-K                                                            â”‚  â”‚
â”‚  â”‚  Sof Zman Shma - Custom (90 min Alos)                                â”‚  â”‚
â”‚  â”‚  Formula: sunrise - 90min + shaos(3, custom(sunrise - 90min, ...))  â”‚  â”‚
â”‚  â”‚  âœ“ 89 communities use this                                            â”‚  â”‚
â”‚  â”‚                                              [View Details] [ğŸ“‹ Copy] â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  ğŸ• London Beth Din                                                   â”‚  â”‚
â”‚  â”‚  Sof Zman Shma - GR"A with High Latitude Fallback                    â”‚  â”‚
â”‚  â”‚  Formula: if (latitude > 55) { ... } else { sunrise + shaos(3, gra) }â”‚  â”‚
â”‚  â”‚  âœ“ 67 communities use this                                            â”‚  â”‚
â”‚  â”‚                                              [View Details] [ğŸ“‹ Copy] â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  ğŸ’¡ Tip: Browse the System Default templates for standard formulas         â”‚
â”‚  [ğŸ“š View System Templates]                                                â”‚
â”‚                                                                             â”‚
â”‚  [Close]                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Expanded View Details:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Formula Details: OU Kosher - Sof Zman Shma GR"A                       [Ã—] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Publisher: OU Kosher                                                      â”‚
â”‚  Organization: Orthodox Union                                              â”‚
â”‚  âœ“ 847 communities use this formula                                        â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Formula â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  sunrise + shaos(3, gra)                                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Explanation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  This calculation follows the Vilna Gaon (GR"A) method, using 3      â”‚  â”‚
â”‚  â”‚  proportional hours from sunrise. Each proportional hour is 1/12 of   â”‚  â”‚
â”‚  â”‚  the time between sunrise and sunset.                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Public Comment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  We follow the widely accepted opinion of the Vilna Gaon (GR"A)      â”‚  â”‚
â”‚  â”‚  for calculating Sof Zman Krias Shema. This is the standard          â”‚  â”‚
â”‚  â”‚  calculation used by most Ashkenazi communities worldwide.            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Sample Calculation (Today) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Location: New York, NY                                               â”‚  â”‚
â”‚  â”‚  Sunrise: 6:34 AM                                                     â”‚  â”‚
â”‚  â”‚  Sunset: 6:47 PM                                                      â”‚  â”‚
â”‚  â”‚  Result: 9:37 AM                                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  [ğŸ“‹ Copy This Formula]  [Close]                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Features:**
- **Search functionality** to find specific zmanim
- **Publisher listing** with:
  - Publisher name and logo
  - Zman name
  - Formula preview
  - Usage count (social proof)
- **View Details** expands to full modal with:
  - Complete formula
  - Explanation
  - Public comment
  - Sample calculation
- **Copy button** imports formula into current zman
- **System Templates** link to browse default formulas
- **Read-only** - cannot edit other publishers' formulas, only copy

---

## Interactive Elements & Technical Specifications

### 1. CodeMirror 6 Configuration

```typescript
import { EditorView } from '@codemirror/view';
import { autocompletion } from '@codemirror/autocomplete';
import { linter } from '@codemirror/lint';
import { syntaxHighlighting } from '@codemirror/language';

const zmanimDSLExtension = [
  autocompletion({
    override: [zmanimAutocomplete],
    activateOnTyping: true,
    closeOnBlur: false,
    icons: true
  }),
  linter(zmanimLinter, {
    delay: 300 // Debounce validation
  }),
  syntaxHighlighting(zmanimHighlightStyle),
  EditorView.updateListener.of((update) => {
    if (update.docChanged) {
      // Auto-save debounced (1 second)
      debouncedValidate(update.state.doc.toString());
      debouncedSave(update.state.doc.toString());
    }
  })
];
```

### 2. Autocomplete Provider

```typescript
import { CompletionContext, CompletionResult } from '@codemirror/autocomplete';

const zmanimAutocomplete = (context: CompletionContext): CompletionResult | null => {
  const word = context.matchBefore(/\w*/);
  if (!word || (word.from === word.to && !context.explicit)) return null;

  return {
    from: word.from,
    options: [
      // === PRIMITIVES ===
      {
        label: 'sunrise',
        type: 'primitive',
        info: 'Geometric sunrise (sun center at horizon)',
        detail: 'primitive'
      },
      {
        label: 'sunset',
        type: 'primitive',
        info: 'Geometric sunset',
        detail: 'primitive'
      },
      {
        label: 'solar_noon',
        type: 'primitive',
        info: 'Solar noon (sun at highest point)',
        detail: 'primitive'
      },
      {
        label: 'civil_dawn',
        type: 'primitive',
        info: 'Civil twilight begins (sun at -6Â°)',
        detail: 'primitive'
      },
      {
        label: 'civil_dusk',
        type: 'primitive',
        info: 'Civil twilight ends (sun at -6Â°)',
        detail: 'primitive'
      },

      // === FUNCTIONS ===
      {
        label: 'solar(',
        type: 'function',
        apply: 'solar(${degrees}, ${direction})',
        info: 'Calculate time when sun is at specific angle below horizon',
        detail: '(degrees: 0-90, direction: before_sunrise | after_sunset)'
      },
      {
        label: 'shaos(',
        type: 'function',
        apply: 'shaos(${hours}, ${base})',
        info: 'Calculate proportional hours (shaos zmaniyos)',
        detail: '(hours: 0.5-12, base: gra | mga | mga_90 | mga_120)'
      },
      {
        label: 'midpoint(',
        type: 'function',
        apply: 'midpoint(${time1}, ${time2})',
        info: 'Calculate exact midpoint between two times',
        detail: '(time1, time2)'
      },

      // === DURATIONS ===
      {
        label: 'min',
        type: 'keyword',
        info: 'Minutes suffix (e.g., 72min)',
        detail: 'duration suffix'
      },
      {
        label: 'hr',
        type: 'keyword',
        info: 'Hours suffix (e.g., 2hr)',
        detail: 'duration suffix'
      },

      // === ZMAN REFERENCES ===
      // Dynamically loaded from publisher's existing zmanim
      ...publisherZmanim.map(z => ({
        label: `@${z.zman_key}`,
        type: 'zman_reference',
        info: `${z.english_name} (${z.hebrew_name})`,
        detail: `formula: ${z.formula_dsl.substring(0, 50)}...`
      }))
    ],
    validFor: /^\w*$/
  };
};
```

### 3. Real-time Validation (Linter)

```typescript
import { Diagnostic } from '@codemirror/lint';
import { EditorView } from '@codemirror/view';

const zmanimLinter = (view: EditorView): Diagnostic[] => {
  const formula = view.state.doc.toString();
  const diagnostics: Diagnostic[] = [];

  try {
    // Parse DSL to AST
    const ast = parseZmanimDSL(formula);

    // Semantic validation
    const errors = validateAST(ast, {
      publisherZmanim,
      allowCircularDeps: false
    });

    errors.forEach(err => {
      diagnostics.push({
        from: err.position.start,
        to: err.position.end,
        severity: err.severity, // 'error' | 'warning' | 'info'
        message: err.message,
        actions: err.suggestions ? [{
          name: 'Did you mean?',
          apply: (view, from, to) => {
            view.dispatch({
              changes: { from, to, insert: err.suggestions[0] }
            });
          }
        }] : undefined
      });
    });
  } catch (parseError) {
    // Syntax error during parsing
    diagnostics.push({
      from: parseError.position || 0,
      to: (parseError.position || 0) + 1,
      severity: 'error',
      message: parseError.message
    });
  }

  return diagnostics;
};
```

### 4. Keyboard Shortcuts

| Shortcut | Action | Implementation |
|----------|--------|----------------|
| `Ctrl/Cmd + Space` | Trigger autocomplete | CodeMirror default |
| `Ctrl/Cmd + S` | Save formula | Custom handler (prevents browser save) |
| `Ctrl/Cmd + Enter` | Preview calculation | Custom handler |
| `Esc` | Close modal | Dialog component handler |
| `Ctrl/Cmd + /` | Toggle comment | CodeMirror comment extension |
| `Tab` | Jump to next placeholder | Snippet completion |
| `Ctrl/Cmd + Z` | Undo | CodeMirror history |
| `Ctrl/Cmd + Shift + Z` | Redo | CodeMirror history |

```typescript
import { keymap } from '@codemirror/view';

const zmanimKeymap = keymap.of([
  {
    key: 'Mod-s',
    run: (view) => {
      handleSaveFormula();
      return true; // Prevent default
    }
  },
  {
    key: 'Mod-Enter',
    run: (view) => {
      handlePreviewCalculation();
      return true;
    }
  }
]);
```

### 5. Smooth Animations (CSS)

```css
/* Modal slide-in animation */
@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.zman-modal {
  animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Formula editor focus state */
.formula-editor {
  transition: box-shadow 0.2s ease, border-color 0.2s ease;
}

.formula-editor:focus-within {
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  border-color: rgb(59, 130, 246);
}

/* AI generation loading pulse */
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.ai-generating {
  animation: pulse 1.5s infinite;
}

/* Preview section expand/collapse */
.preview-section {
  transition: max-height 0.3s ease, opacity 0.3s ease;
  overflow: hidden;
}

.preview-section.collapsed {
  max-height: 0;
  opacity: 0;
}

.preview-section.expanded {
  max-height: 2000px;
  opacity: 1;
}

/* Autocomplete dropdown slide */
@keyframes slideDown {
  from {
    transform: translateY(-8px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.cm-tooltip-autocomplete {
  animation: slideDown 0.15s ease;
}

/* Error state shake */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-4px); }
  75% { transform: translateX(4px); }
}

.formula-error {
  animation: shake 0.3s ease;
}
```

### 6. Responsive Design

```css
/* Desktop: Side modal (full height, right side) */
@media (min-width: 768px) {
  .zman-modal {
    position: fixed;
    right: 0;
    top: 0;
    bottom: 0;
    width: 600px;
    height: 100vh;
    overflow-y: auto;
  }
}

/* Mobile: Bottom sheet */
@media (max-width: 767px) {
  .zman-modal {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    max-height: 90vh;
    border-radius: 16px 16px 0 0;
    overflow-y: auto;
  }

  /* Swipe-down to dismiss */
  .zman-modal-handle {
    display: block;
    width: 40px;
    height: 4px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 2px;
    margin: 12px auto 0;
  }
}
```

---

## Component Architecture

### React Component Structure

```
EditZmanModal/
â”œâ”€â”€ index.tsx                      # Main modal container
â”œâ”€â”€ FormulaEditor.tsx              # CodeMirror wrapper
â”œâ”€â”€ AIGenerator.tsx                # AI formula generation panel
â”œâ”€â”€ ExplanationPanel.tsx           # AI explanation display
â”œâ”€â”€ CommentEditor.tsx              # Public comment editor
â”œâ”€â”€ LivePreview.tsx                # Real-time calculation preview
â”œâ”€â”€ WeeklyPreview.tsx              # Week calendar view
â”œâ”€â”€ BrowseTemplates.tsx            # Browse other publishers
â”œâ”€â”€ ValidationErrors.tsx           # Error display component
â”œâ”€â”€ QuickReference.tsx             # DSL syntax cheat sheet
â””â”€â”€ hooks/
    â”œâ”€â”€ useFormula.ts              # Formula state management
    â”œâ”€â”€ useValidation.ts           # Real-time validation
    â”œâ”€â”€ useAIGeneration.ts         # AI API calls
    â”œâ”€â”€ usePreviewCalculation.ts   # Preview calculations
    â””â”€â”€ useAutosave.ts             # Debounced auto-save
```

### State Management

```typescript
interface EditZmanState {
  // Zman data
  zmanId: string;
  hebrewName: string;
  englishName: string;
  formulaDSL: string;
  aiExplanation: string | null;
  publisherComment: string;
  isEnabled: boolean;
  isVisible: boolean;
  isRequired: boolean; // Read-only, from template

  // UI state
  mode: 'view' | 'edit' | 'ai-generate' | 'browse';
  isValidating: boolean;
  validationErrors: ValidationError[];
  isDirty: boolean;
  isSaving: boolean;

  // Preview state
  previewDate: Date;
  previewLocation: Location;
  calculatedValue: Time | null;
  calculationBreakdown: CalculationStep[];

  // Weekly preview
  weeklyPreviewExpanded: boolean;
  previewWeekStart: Date;
  weeklyCalculations: WeeklyZman[];
}
```

---

## API Endpoints Required

### Formula Management

```typescript
// Validate formula (client-side calls for real-time validation)
POST /api/publisher/zmanim/validate
Body: { formula_dsl: string }
Response: {
  valid: boolean,
  errors?: ValidationError[],
  dependencies?: string[]
}

// Update zman formula
PUT /api/publisher/zmanim/{zmanId}
Body: {
  formula_dsl: string,
  publisher_comment?: string
}
Response: { data: PublisherZman }

// Get preview calculation
POST /api/publisher/zmanim/{zmanId}/preview
Body: {
  formula_dsl: string,
  date: string,
  location_id: string
}
Response: {
  data: {
    calculated_time: string,
    breakdown: CalculationStep[]
  }
}

// Get weekly preview
POST /api/publisher/zmanim/{zmanId}/preview-week
Body: {
  formula_dsl: string,
  week_start: string, // ISO date
  location_id: string
}
Response: {
  data: {
    week: WeeklyZman[]
  }
}
```

### AI Integration

```typescript
// Generate formula from natural language
POST /api/ai/generate-formula
Body: {
  prompt: string,
  context?: string
}
Response: {
  data: {
    formula_dsl: string,
    explanation: string,
    confidence: number
  }
}

// Generate AI explanation from formula
POST /api/ai/explain-formula
Body: {
  formula_dsl: string,
  zman_name: string
}
Response: {
  data: {
    explanation: string
  }
}

// Generate public comment
POST /api/ai/generate-comment
Body: {
  formula_dsl: string,
  explanation: string,
  zman_name: string
}
Response: {
  data: {
    comment: string
  }
}
```

### Browse Templates

```typescript
// Search formulas from other publishers
GET /api/zmanim/browse?search={query}&zman_key={key}
Response: {
  data: [
    {
      publisher_id: string,
      publisher_name: string,
      zman_key: string,
      english_name: string,
      hebrew_name: string,
      formula_dsl: string,
      usage_count: number
    }
  ]
}

// Get formula details
GET /api/zmanim/{publisherId}/{zmanKey}
Response: {
  data: {
    publisher: PublisherInfo,
    zman: ZmanDetails,
    sample_calculation: CalculationPreview
  }
}
```

---

## Performance Optimizations

### 1. Debouncing

- **Validation:** 300ms debounce on formula changes
- **Auto-save:** 1000ms debounce on formula changes
- **AI regeneration:** Prevent spam clicks (cooldown period)

### 2. Lazy Loading

- CodeMirror editor loaded only when "Edit" clicked
- Weekly preview loaded on-demand
- Browse templates modal lazy-loaded

### 3. Caching

- Formula validation results cached (formula hash â†’ result)
- Preview calculations cached (formula + date + location â†’ result)
- AI explanations cached (formula hash â†’ explanation)

### 4. Optimistic Updates

- Formula changes reflected immediately in UI
- Validation runs async, shows loading state
- Save confirmation shown immediately, syncs in background

---

## Accessibility (A11y)

### Keyboard Navigation

- All interactive elements keyboard-accessible
- Modal can be closed with `Esc`
- Tab order follows logical flow
- Focus trap within modal

### Screen Reader Support

```html
<div role="dialog" aria-labelledby="modal-title" aria-modal="true">
  <h2 id="modal-title">Edit: Sof Zman Shma - GR"A</h2>

  <div role="group" aria-labelledby="formula-label">
    <label id="formula-label">Formula (DSL)</label>
    <div class="cm-editor" role="textbox" aria-multiline="true">
      <!-- CodeMirror content -->
    </div>
  </div>

  <div role="status" aria-live="polite" aria-atomic="true">
    <!-- Validation messages -->
  </div>
</div>
```

### ARIA Labels

- All buttons have clear labels
- Error messages announced to screen readers
- Loading states announced
- Success confirmations announced

---

## Error Handling & User Feedback

### Error States

1. **Network errors** - "Could not save. Check your connection."
2. **Validation errors** - Inline with suggestions
3. **AI generation failures** - "Could not generate. Try again."
4. **Rate limit exceeded** - "AI usage limit reached. Try tomorrow or contact admin."

### Success States

1. **Formula saved** - Toast notification
2. **AI generated** - Smooth reveal animation
3. **Preview updated** - Fade-in new values

### Loading States

1. **Validating** - Subtle spinner in formula editor
2. **Saving** - Button shows "Saving..."
3. **AI generating** - Pulsing animation
4. **Preview loading** - Skeleton screens

---

## Future Enhancements (Post-Epic 4)

1. **Formula templates library** - Pre-built complex formulas
2. **Visual formula builder** - Drag-and-drop interface (alternative to DSL)
3. **Diff viewer** - Compare formula versions side-by-side
4. **Collaborative editing** - Multiple users editing same algorithm
5. **Formula marketplace** - Share and discover formulas
6. **Mobile app** - Native mobile formula editor
7. **Voice input** - Describe formula with voice, AI generates
8. **Formula versioning** - Git-like version control

---

## References

- [CodeMirror 6 Documentation](https://codemirror.net/docs/)
- [Radix UI Dialog](https://www.radix-ui.com/docs/primitives/components/dialog)
- [shadcn/ui Sheet](https://ui.shadcn.com/docs/components/sheet)
- [Apple Human Interface Guidelines](https://developer.apple.com/design/human-interface-guidelines/)

---

**Generated:** 2025-11-28
**For:** Epic 4 - Zmanim Lab
**Status:** Planning Phase

# Dev Tasks - Code Quality Fixes

**Created:** 2025-11-28
**Status:** COMPLETED
**Priority:** HIGH
**Last Updated:** 2025-11-28
**Progress:** 88 warnings → 34 warnings (0 errors)

---

## How to Use This File

A dev agent should:
1. Read this file
2. Complete tasks in order (Priority 1 first)
3. Mark each task `[x]` when done
4. Run ESLint after each section to verify

---

## Priority 1: ESLint Errors (MUST FIX - 15 total) ✅ COMPLETED

### 1.1 Unescaped Entities in JSX

Replace `"` with `&quot;` and `'` with `&apos;`:

- [x] `web/app/admin/page.tsx:96,104`
- [x] `web/app/admin/publishers/[id]/page.tsx:589`
- [x] `web/app/publisher/analytics/page.tsx:104`
- [x] `web/app/publisher/dashboard/page.tsx:199`
- [x] `web/components/onboarding/steps/ReviewPublishStep.tsx:59`
- [x] `web/components/onboarding/steps/WelcomeStep.tsx:36,72`

### 1.2 Other Errors

- [x] `web/components/publisher/CitySelector.tsx:125` - Change `let url` to `const url`
- [x] `web/components/ui/textarea.tsx:6` - Fixed empty interface to type alias
- [x] `web/tailwind.config.ts:136` - Already fixed in codebase

---

## Priority 2: Remove Duplicated API_BASE (11 files) ✅ COMPLETED

All files now import from `@/lib/api`:
- [x] `web/app/accept-invitation/page.tsx`
- [x] `web/app/admin/settings/page.tsx`
- [x] `web/app/admin/publishers/[id]/page.tsx`
- [x] `web/app/admin/publishers/new/page.tsx`
- [x] `web/app/publisher/activity/page.tsx`
- [x] `web/app/become-publisher/page.tsx`
- [x] `web/app/zmanim/[cityId]/page.tsx`
- [x] `web/app/zmanim/[cityId]/[publisherId]/page.tsx`
- [x] `web/app/publisher/analytics/page.tsx`
- [x] `web/app/publisher/coverage/page.tsx`
- [x] `web/app/publisher/team/page.tsx`

---

## Priority 3: Fix Hardcoded Colors (5 locations) ✅ COMPLETED

All hardcoded colors replaced with design tokens:
- [x] `web/components/ui/badge.tsx` - Using design tokens
- [x] `web/components/DatePicker.tsx` - Using design tokens
- [x] `web/components/LocationInput.tsx` - Using design tokens
- [x] `web/app/become-publisher/page.tsx` - Using design tokens

---

## Priority 4: Create Centralized Auth Hook ✅ COMPLETED

Hook created at `web/lib/hooks/useAuthenticatedFetch.ts` and exported via `web/lib/hooks/index.ts`.

### Implementation (already exists)

### 4.1 Create `web/lib/hooks/useAuthenticatedFetch.ts`

```typescript
'use client';

import { useCallback } from 'react';
import { useAuth } from '@clerk/nextjs';
import { usePublisherContext } from '@/providers/PublisherContext';
import { API_BASE } from '@/lib/api';

export class ApiError extends Error {
  constructor(
    message: string,
    public status: number,
    public data?: unknown
  ) {
    super(message);
    this.name = 'ApiError';
  }
}

interface FetchOptions extends Omit<RequestInit, 'headers'> {
  headers?: Record<string, string>;
  skipPublisherId?: boolean;
}

export function useAuthenticatedFetch() {
  const { getToken } = useAuth();
  const { selectedPublisher } = usePublisherContext();

  const fetchWithAuth = useCallback(async <T>(
    endpoint: string,
    options: FetchOptions = {}
  ): Promise<T> => {
    const { skipPublisherId, headers: customHeaders, ...fetchOptions } = options;

    const token = await getToken();
    if (!token) {
      throw new Error('Not authenticated - no token available');
    }

    const headers: Record<string, string> = {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`,
      ...customHeaders,
    };

    if (!skipPublisherId && selectedPublisher?.id) {
      headers['X-Publisher-Id'] = selectedPublisher.id;
    }

    const response = await fetch(`${API_BASE}${endpoint}`, {
      ...fetchOptions,
      headers,
    });

    if (!response.ok) {
      const error = await response.json().catch(() => ({ message: response.statusText }));
      throw new ApiError(
        error.message || `API Error: ${response.status}`,
        response.status,
        error
      );
    }

    const json = await response.json();
    return json.data !== undefined ? json.data : json;
  }, [getToken, selectedPublisher]);

  return { fetchWithAuth };
}
```

### 4.2 Create `web/lib/hooks/index.ts`

```typescript
export { useAuthenticatedFetch, ApiError } from './useAuthenticatedFetch';
```

---

## Priority 5: Remove Unused Variables (23 total) ✅ COMPLETED

### 5.1 Unused imports removed
- [x] `web/components/editor/DSLEditor.tsx` - Removed unused imports
- [x] `web/components/zmanim/FormulaPanel.tsx` - Removed X import
- [x] `web/app/zmanim/[cityId]/[publisherId]/page.tsx` - Removed ZmanFormula

### 5.2 Unused catch variables fixed
- [x] `web/app/accept-invitation/page.tsx` - Changed `catch (err)` to `catch`
- [x] `web/app/become-publisher/page.tsx` - Changed `catch (err)` to `catch`
- [x] `web/app/publisher/activity/page.tsx` - Removed unused error state
- [x] `web/app/publisher/team/page.tsx` - Changed `catch (err)` to `catch`

### 5.3 Unused variables fixed
- [x] `web/components/preview/WeeklyPreview.tsx` - Removed unused timezone from destructuring

---

## Priority 6: Replace img with Next.js Image (9 files) ✅ COMPLETED

All `<img>` tags replaced with `<Image>` from next/image with `fill` and `unoptimized` props:

- [x] `web/app/admin/publishers/[id]/page.tsx` - User avatars
- [x] `web/app/publisher/team/page.tsx` - Team member avatars
- [x] `web/app/zmanim/[cityId]/[publisherId]/page.tsx` - Publisher logo
- [x] `web/app/zmanim/[cityId]/page.tsx` - Publisher logos
- [x] `web/components/PublisherCard.tsx` - Publisher logo
- [x] `web/components/algorithms/BrowseAlgorithms.tsx` - Algorithm publisher logos
- [x] `web/components/publisher/LogoUpload.tsx` - Logo preview (uses NextImage alias)
- [x] `web/components/shared/PublisherCard.tsx` - Publisher logo
- [x] `web/components/ui/avatar.tsx` - Avatar images

---

## Verification Commands

After each priority section, run:

```bash
cd /home/coder/workspace/zmanim-lab/web

# Check ESLint
npx eslint . --ext .ts,.tsx 2>&1 | head -100

# Check TypeScript
npm run type-check

# Quick build test
npm run build 2>&1 | tail -20
```

---

## Reference Documents

- `docs/coding-standards.md` - Cast-iron rules for code style
- `docs/code-review-recommendations-2025-11-28.md` - Full analysis with context
- `web/.eslintrc.json` - ESLint configuration

---

## Notes

- Go backend passes `go vet` with no issues - no changes needed
- TypeScript compilation passes - focus on ESLint issues
- Authentication code structure is correct - just needs centralization

---

## Remaining Warnings (34 total - Lower Priority)

### React Hooks Dependencies (~20 warnings)
These are `react-hooks/exhaustive-deps` warnings for useEffect/useCallback/useMemo missing dependencies.
These are intentional in most cases (callbacks that should only run on mount).

### TypeScript `any` Types (~6 warnings)
Located in:
- `web/app/admin/publishers/new/page.tsx`
- `web/app/admin/settings/page.tsx`
- `web/app/debug-auth/page.tsx`
- `web/lib/api.ts`
- `web/middleware.ts`

These are lower priority and can be addressed in a future cleanup.
